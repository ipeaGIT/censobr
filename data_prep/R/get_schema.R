# get_schema(year=2010, dataset="emigration")

library(arrow)
library(dplyr)

get_schema <- function(year, dataset){

  if (year==2010 & dataset=="population") {
  sss <- schema(
      code_muni= int32(),
      code_state= int16(),
      abbrev_state= string(),
      name_state= string(),
      code_region= int8(),
      name_region = string(),
      code_weighting= string(),
      V0001 = int32(),
      V0002 = int32(),
      V0011 = string(),
      V0300 = double(),
      V0010 = double(),
      V1001 = int8(),
      V1002 = string(),
      V1003 = string(),
      V1004 = string(),
      V1006 = int8(),
      V0502 = int8(),
      V0504 = int8(),
      V0601 = int8(),
      V6033 = int32(),
      V6036 = int32(), # idade em anos
      V6037 = int32(),
      V6040 = int8(),
      V0606 = int8(),
      V0613 = int8(),
      V0614 = int8(),
      V0615 = int8(),
      V0616 = int8(),
      V0617 = int8(),
      V0618 = int8(),
      V0619 = int8(),
      V0620 = int8(),
      V0621 = int32(),
      V0622 = int32(),
      V6222 = int32(),
      V6224 = int32(),
      V0623 = int32(),
      V0624 = int32(),
      V0625 = int8(),
      V6252 = int32(),
      V6254 = string(),
      V6256 = int32(),
      V0626 = int8(),
      V6262 = int32(),
      V6264 = int32(),
      V6266 = int32(),
      V0627 = int8(),
      V0628 = int8(),
      V0629 = int8(),
      V0630 = int8(),
      V0631 = int8(),
      V0632 = int8(),
      V0633 = int8(),
      V0634 = int8(),
      V0635 = int8(),
      V6400 = int8(),
      V6352 = int32(),
      V6354 = int32(),
      V6356 = int32(),
      V0636 = int32(),
      V6362 = int32(),
      V6364 = int32(),
      V6366 = int32(),
      V0637 = int8(),
      V0638 = int32(),
      V0639 = int8(),
      V0640 = int8(),
      V0641 = int8(),
      V0642 = int8(),
      V0643 = int8(),
      V0644 = int8(),
      V0645 = int8(),
      V6461 = int32(),
      V6471 = int32(),
      V0648 = int8(),
      V0649 = int8(),
      V0650 = int8(),
      V0651 = int8(),
      V6511 = double(),
      V6513 = double(),
      V6514 = double(),
      V0652 = int8(),
      V6521 = double(),
      V6524 = double(),
      V6525 = double(),
      V6526 = double(),
      V6527 = double(),
      V6528 = double(),
      V6529 = double(),
      V6530 = double(),
      V6531 = double(),
      V6532 = double(),
      V0653 = int32(),
      V0654 = int8(),
      V0655 = int8(),
      V0656 = int8(),
      V0657 = int8(),
      V0658 = int8(),
      V0659 = int8(),
      V6591 = double(),
      V0660 = int8(),
      V6602 = int32(),
      V6604 = int32(),
      V6606 = int32(),
      V0661 = int8(),
      V0662 = int8(),
      V0663 = int8(),
      V6631 = int8(),
      V6632 = int8(),
      V6633 = int8(),
      V0664 = int8(),
      V6641 = double(),
      V6642 = int8(),
      V6643 = int8(),
      V0665 = int8(),
      V6660 = int8(),
      V6664 = int8(),
      V0667 = int8(),
      V0668 = int8(),
      V6681 = int8(),
      V6682 = int32(),
      V0669 = int16(),
      V6691 = int16(),
      V6692 = int16(),
      V6693 = int16(),
      V6800 = int16(),
      V0670 = int16(),
      V0671 = int16(),
      V6900 = int16(),
      V6910 = int16(),
      V6920 = int16(),
      V6930 = int16(),
      V6940 = int16(),
      V6121 = int32(),
      V0604 = int16(),
      V0605 = int16(),
      V5020 = int16(),
      V5060 = int16(),
      V5070 = double(),
      V5080 = double(),
      V6462 = int32(),
      V6472 = int32(),
      V5110 = int8(),
      V5120 = int8(),
      V5030 = int8(),
      V5040 = int8(),
      V5090 = int8(),
      V5100 = int8(),
      V5130 = int8(),
      M0502 = int8(),
      M0601 = int8(),
      M6033 = int8(),
      M0606 = int8(),
      M0613 = int8(),
      M0614 = int8(),
      M0615 = int8(),
      M0616 = int8(),
      M0617 = int8(),
      M0618 = int8(),
      M0619 = int8(),
      M0620 = int8(),
      M0621 = int8(),
      M0622 = int8(),
      M6222 = int8(),
      M6224 = int8(),
      M0623 = int8(),
      M0624 = int8(),
      M0625 = int8(),
      M6252 = int8(),
      M6254 = int8(),
      M6256 = int8(),
      M0626 = int8(),
      M6262 = int8(),
      M6264 = int8(),
      M6266 = int8(),
      M0627 = int8(),
      M0628 = int8(),
      M0629 = int8(),
      M0630 = int8(),
      M0631 = int8(),
      M0632 = int8(),
      M0633 = int8(),
      M0634 = int8(),
      M0635 = int8(),
      M6352 = int8(),
      M6354 = int8(),
      M6356 = int8(),
      M0636 = int8(),
      M6362 = int8(),
      M6364 = int8(),
      M6366 = int8(),
      M0637 = int8(),
      M0638 = int8(),
      M0639 = int8(),
      M0640 = int8(),
      M0641 = int8(),
      M0642 = int8(),
      M0643 = int8(),
      M0644 = int8(),
      M0645 = int8(),
      M6461 = int8(),
      M6471 = int8(),
      M0648 = int8(),
      M0649 = int8(),
      M0650 = int8(),
      M0651 = int8(),
      M6511 = int8(),
      M0652 = int8(),
      M6521 = int8(),
      M0653 = int8(),
      M0654 = int8(),
      M0655 = int8(),
      M0656 = int8(),
      M0657 = int8(),
      M0658 = int8(),
      M0659 = int8(),
      M6591 = int8(),
      M0660 = int8(),
      M6602 = int8(),
      M6604 = int8(),
      M6606 = int8(),
      M0661 = int8(),
      M0662 = int8(),
      M0663 = int8(),
      M6631 = int8(),
      M6632 = int8(),
      M6633 = int8(),
      M0664 = int8(),
      M6641 = int8(),
      M6642 = int8(),
      M6643 = int8(),
      M0665 = int8(),
      M6660 = int8(),
      M0667 = int8(),
      M0668 = int8(),
      M6681 = int8(),
      M6682 = int8(),
      M0669 = int8(),
      M6691 = int8(),
      M6692 = int8(),
      M6693 = int8(),
      M0670 = int8(),
      M0671 = int8(),
      M6800 = int8(),
      M6121 = int8(),
      M0604 = int8(),
      M0605 = int8(),
      M6462 = int8(),
      M6472 = int8(),
      V1005 = int8(),
    )
  }

  if (year==2010 & dataset=="emigration") {

    sss <- schema(
      code_muni = int32(),
      code_state = int16(),
      abbrev_state = string(),
      name_state = string(),
      code_region = int8(),
      name_region = string(),
      code_weighting = string(),
      V0001 = string(),
      V0002 = string(),
      V0011 = string(),
      V0300 = double(),
      V0010 = double(),
      V1001 = int8(),
      V1002 = string(),
      V1003 = string(),
      V1004 = string(),
      V1006 = int8(),
      V0303 = int8(),
      V0304 = int32(),
      V0305 = int32(),
      V3061 = int32(),
      M0303 = int8(),
      M0304 = int8(),
      M0305 = int8(),
      M3061 = int8(),
      V1005 = int8()
    )
  }
return(sss)
}




v3 <- read_emigration(year=2010) |> head() |> dplyr::collect()
v5 <- read_emigration(year=2010) |> head() |> dplyr::collect()


head(v5)
head(v3)


sapply(v3, class) |> table()
sapply(v5, class) |> table()


v5 <- read_population(year=2010) |>  dplyr::collect()
f <- censobr_cache()
f <- 'C:/Users/rafap/AppData/Local/Temp/Rtmp8mdg3M/my_temp_dir/data_release_v0.5.0/2010_population_v0.5.0.parquet'

sss <- get_schema(year=2010, dataset="population")
v51 <- open_dataset(f, schema = sss)



## 6.4) save single parquet tile ----------------------------------------------
arrow::write_parquet(
  x = v51,
  sink = '2010_population_intcompress.parquet',
  compression='zstd',
  compression_level = 22)

file.size(f)
file.size('2010_population_int.parquet')


